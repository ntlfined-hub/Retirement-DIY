<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>แนวทางแก้หนี้ DIY — เกมเลือกเส้นทาง + AI Advisor</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-from:#f8fafc; --bg-to:#f1f5f9;
      --card:#ffffff; --line:#e5e7eb; --ink:#0f172a; --muted:#64748b;
      --brand:#7dd3fc; --brand-strong:#38bdf8;
    }
    body{ font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Kanit',sans-serif; color:var(--ink) }
    .gradient-bg{ background:linear-gradient(135deg,var(--bg-from),var(--bg-to)); }
    .card{ background:var(--card); border:1px solid var(--line); border-radius:24px; box-shadow:0 10px 30px rgba(2,8,23,.06) }
    .btn{ display:inline-flex; align-items:center; justify-content:center; gap:.55rem; padding:.9rem 1.05rem; border-radius:999px; border:1px solid var(--line); font-weight:600; transition:transform .06s ease, box-shadow .2s ease }
    .btn:active{ transform:translateY(1px) }
    .btn-primary{ background:#111827; color:#fff }
    .btn-brand{ background:var(--brand-strong); color:#083344 }
    .btn-ghost{ background:#fff; color:var(--ink) }
    .choice{ border:1px solid var(--line); border-radius:18px; padding:1rem; cursor:pointer; transition:transform .08s ease, box-shadow .2s ease, border-color .2s ease; background:#fff }
    .choice:hover{ transform:translateY(-1px); box-shadow:0 10px 26px rgba(2,8,23,.08); border-color:#dbeafe }
    .badge{ display:inline-flex; align-items:center; gap:.45rem; padding:.32rem .7rem; border-radius:999px; border:1px solid var(--line); font-size:.8rem; color:var(--muted); background:#fff }
    .pill{ border:1px dashed var(--line); padding:.45rem .8rem; border-radius:999px; font-size:.82rem; color:var(--muted); background:#fff }
    .progress{ height:12px; background:#e2e8f0; border-radius:999px; overflow:hidden }
    .progress>span{ display:block; height:100%; background:linear-gradient(90deg,#a5b4fc,#7dd3fc) }
    .input{ width:100%; border:1px solid var(--line); border-radius:16px; padding:.9rem 1rem; font-size:1.05rem; background:#fff; outline:none }
    .input:focus{ border-color:#c7d2fe; box-shadow:0 0 0 6px rgba(165,180,252,.25) }
    .metric-card{ text-align:center; display:flex; flex-direction:column; align-items:center }
    .advice{ font-size:.78rem; color:#475569; margin-top:.4rem }
    .mono{ font-variant-numeric: tabular-nums; }
    @media print{ .hidden-print{ display:none !important } .card{ box-shadow:none } }
  </style>
</head>
<body class="gradient-bg min-h-screen">

  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur bg-white/70 border-b border-slate-200">
    <div class="max-w-4xl mx-auto px-4 py-3 flex items-center justify-between">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-2xl bg-sky-100 flex items-center justify-center shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 6v12"/><path d="M17 12H7"/></svg>
        </div>
        <div>
          <h1 class="text-lg font-bold leading-tight">แนวทางแก้หนี้ DIY — เกมเลือกเส้นทาง</h1>
          <p class="text-sm text-slate-500"><span id="totalStepsText"></span> • มินิมอล • โค้งมน • พาสเทล</p>
        </div>
      </div>
      <div class="flex items-center gap-2">
        <button id="btnAiSettings" class="btn btn-ghost hidden-print" type="button">ตั้งค่า AI</button>
        <button id="btnPrint" class="btn btn-ghost hidden-print" type="button">พิมพ์สรุป</button>
        <button id="btnReset" class="btn btn-primary hidden-print" type="button">เริ่มใหม่</button>
      </div>
    </div>
  </header>

  <!-- Main -->
  <main class="max-w-4xl mx-auto px-4 py-6 space-y-5">

    <!-- Progress -->
    <section class="card p-4">
      <div class="flex items-center justify-between mb-2">
        <span class="badge"><span id="stepLabel">คำถามที่ 1</span><span>จาก <span id="totalSteps">12</span></span></span>
        <span class="pill" id="pathBadge">เริ่มต้น</span>
      </div>
      <div class="progress"><span id="progressBar" style="width:8.3%"></span></div>
    </section>

    <!-- Question Card -->
    <section id="qaCard" class="card p-5">
      <div class="flex items-start gap-3 mb-4">
        <div class="w-9 h-9 rounded-2xl bg-sky-100 flex items-center justify-center shrink-0">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-4.5 h-4.5 text-sky-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="M12 8v4"/><path d="M12 16h.01"/></svg>
        </div>
        <div class="flex-1">
          <h2 id="qTitle" class="text-xl font-semibold leading-snug mb-1">ปัจจุบันเงินเดือนติดลบหรือไม่?</h2>
          <p id="qHint" class="text-sm text-slate-500">เลือกระหว่าง 2 ตัวเลือก เพื่อไปยังคำถามถัดไป</p>
        </div>
      </div>

      <div id="choices" class="grid sm:grid-cols-2 gap-3"></div>

      <!-- แถวปุ่มสำหรับ “หน้ากรอกตัวเลข” -->
      <div id="navRow" class="mt-5 hidden">
        <div class="flex items-center justify-between">
          <button id="btnBackInline" class="btn btn-ghost" type="button">ย้อนกลับ</button>
          <button id="btnNextInline" class="btn btn-brand" type="button">ถัดไป</button>
        </div>
      </div>

      <!-- ปุ่มย้อนกลับ (ใช้กับหน้าตัวเลือก) -->
      <div id="backOnlyRow" class="flex items-center justify-between mt-5">
        <button id="btnBack" class="btn btn-ghost hidden-print" disabled type="button">ย้อนกลับ</button>
        <span></span>
      </div>
    </section>

    <!-- Result Card -->
    <section id="resultCard" class="card p-6 hidden">
      <div class="flex items-start gap-3 mb-4">
        <div class="w-12 h-12 rounded-2xl bg-emerald-100 flex items-center justify-center shrink-0 shadow-sm">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-emerald-600" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 20l9-5-9-5-9 5 9 5z"/><path d="M12 12l9-5-9-5-9 5 9 5z"/></svg>
        </div>
        <div>
          <h2 class="text-2xl font-bold leading-tight mb-1">สรุปแนวทางที่เหมาะกับคุณ</h2>
          <p class="text-sm text-slate-500">Action Plan 30 วัน • Roadmap 12 เดือน • Checklist</p>
        </div>
      </div>

      <div id="endingBadge" class="mb-4"></div>

      <!-- Metrics (กลาง + Advice) -->
      <div id="metricsAttach" class="grid md:grid-cols-4 gap-3 mb-4 hidden">
        <div class="card p-4 metric-card">
          <div class="text-sm text-slate-500">สภาพคล่อง/เดือน</div>
          <div id="r_cashflow" class="text-2xl font-bold mt-0.5 mono">-</div>
          <div id="a_cashflow" class="advice"></div>
        </div>
        <div class="card p-4 metric-card">
          <div class="text-sm text-slate-500">DTI</div>
          <div id="r_dti" class="text-2xl font-bold mt-0.5 mono">-</div>
          <div id="a_dti" class="advice"></div>
        </div>
        <div class="card p-4 metric-card">
          <div class="text-sm text-slate-500">อัตราออม</div>
          <div id="r_saving" class="text-2xl font-bold mt-0.5 mono">-</div>
          <div id="a_saving" class="advice"></div>
        </div>
        <div class="card p-4 metric-card">
          <div class="text-sm text-slate-500">เงินฉุกเฉิน (เดือน)</div>
          <div id="r_eme" class="text-2xl font-bold mt-0.5 mono">-</div>
          <div id="a_eme" class="advice"></div>
        </div>
      </div>

      <!-- AI ADVISOR -->
      <div class="card p-5 mt-4">
        <div class="flex items-center justify-between gap-2">
          <div>
            <h3 class="font-semibold text-lg">ที่ปรึกษาอัจฉริยะ (AI Advisor)</h3>
            <p class="text-sm text-slate-500">วิเคราะห์ตามตัวเลขของคุณ และให้คำแนะนำเป็นขั้นตอน</p>
          </div>
          <div class="flex items-center gap-2">
            <button id="btnRunOffline" class="btn btn-brand" type="button">แนะนำแบบออฟไลน์ทันที</button>
            <button id="btnRunOnline" class="btn btn-primary" type="button">วิเคราะห์ด้วย AI (ออนไลน์)</button>
          </div>
        </div>

        <div class="mt-3">
          <label class="text-sm text-slate-600">เพิ่มบริบท (ถ้ามี):</label>
          <textarea id="aiExtra" class="input mt-1" rows="2" placeholder="เช่น มีหนี้นอกระบบ 5,000/เดือน ดอกสูง อยากปิดภายใน 6 เดือน ฯลฯ"></textarea>
        </div>

        <div id="aiOutput" class="mt-4 space-y-3">
          <div class="text-sm text-slate-500">ผลลัพธ์ AI จะแสดงที่นี่</div>
        </div>

        <p class="text-xs text-slate-400 mt-4">* ข้อความนี้เป็นคำแนะนำทั่วไปด้านการเงินส่วนบุคคล ไม่ใช่คำแนะนำการลงทุน โปรดพิจารณาความเหมาะสมตามบริบทของคุณ</p>
      </div>

      <div class="grid md:grid-cols-2 gap-4 mt-4">
        <div class="card p-4">
          <h3 class="font-semibold text-lg mb-2">Action Plan 30 วันแรก</h3>
          <ul id="plan30" class="list-disc pl-5 space-y-1"></ul>
        </div>
        <div class="card p-4">
          <h3 class="font-semibold text-lg mb-2">Roadmap จัดการหนี้ 12 เดือน</h3>
          <ul id="roadmap12" class="list-disc pl-5 space-y-1"></ul>
        </div>
      </div>

      <div class="card p-4 mt-4">
        <h3 class="font-semibold text-lg mb-2">Checklist ต้องทำทันที</h3>
        <ul id="checklist" class="list-check space-y-2"></ul>
      </div>

      <div class="flex flex-wrap gap-2 mt-5 hidden-print">
        <button id="btnCopy" class="btn btn-brand" type="button">คัดลอกสรุป</button>
        <button id="btnStartOver" class="btn btn-primary" type="button">เริ่มใหม่</button>
      </div>
    </section>

  </main>

  <!-- AI Settings Modal -->
  <div id="aiSettings" class="fixed inset-0 z-50 hidden">
    <div class="absolute inset-0 bg-black/30"></div>
    <div class="relative max-w-lg mx-auto mt-24 card p-5">
      <h3 class="font-semibold text-lg mb-2">ตั้งค่า AI (ออนไลน์)</h3>
      <p class="text-sm text-slate-500 mb-3">ใส่ค่าด้านล่างเพื่อให้โค้ดเรียกใช้งานผู้ให้บริการที่เข้ากันได้กับ OpenAI API</p>
      <div class="space-y-3">
        <div>
          <label class="text-sm">API Base URL</label>
          <input id="aiBase" class="input mt-1" placeholder="เช่น https://api.openai.com/v1">
        </div>
        <div>
          <label class="text-sm">API Key</label>
          <input id="aiKey" class="input mt-1" placeholder="sk-********" type="password">
        </div>
        <div>
          <label class="text-sm">Model</label>
          <input id="aiModel" class="input mt-1" value="gpt-4o-mini">
        </div>
      </div>
      <div class="flex justify-end gap-2 mt-4">
        <button id="btnCloseSettings" class="btn btn-ghost" type="button">ปิด</button>
        <button id="btnSaveSettings" class="btn btn-primary" type="button">บันทึก</button>
      </div>
      <p class="text-xs text-slate-400 mt-3">* คีย์นี้จะถูกเก็บในหน่วยความจำเบราว์เซอร์ (localStorage) ของคุณเท่านั้น</p>
    </div>
  </div>

  <script>
  // ===== Config & Helpers =====
  const TOTAL_STEPS = 12;
  const fmtBaht = (n)=> (isFinite(n)? new Intl.NumberFormat('th-TH',{style:'currency',currency:'THB',maximumFractionDigits:0}).format(n):'-');
  const fmtPct  = (x)=> (isFinite(x)? (x*100).toFixed(0)+'%':'-');
  const ceil = (x)=> Math.ceil(x);

  const state = {
    step:1, path:[], answers:{}, isTransitioning:false,
    tags:{ cashflowNegative:null, cause:null, canReduce:null, canIncome:null, debtTrend:null, debtType:null, creditBad:null, dtiHigh:null, creditRisk:null },
    numeric:{ inc:0, living:0, debtpay:0, savingMonthly:0, eme:0 },
    metrics:null, currentQ:'q1'
  };

  // ===== ENDINGS (ย่อ) =====
  const ENDINGS = {};
  ENDINGS.A={title:'Ending A — Cashflow Fix',desc:'ติดลบเพราะฟุ่มเฟือย แต่ยังแก้ได้ด้วยการจัดงบและตัดรายจ่ายผูกมัด',plan30:['แช่แข็งบัตร','งดผ่อนของ/สมาชิก','ใช้ระบบซอง','ตั้งเพดานรายจ่าย ≤ 70%'],roadmap12:['1–3: ปิดก้อนเล็ก','4–6: ลดวงเงินบัตร','7–12: โปะก้อนใหญ่'],checklist:['หยุดสร้างหนี้ใหม่','บันทึกรายจ่ายทุกวัน','เคลียร์ของผูกมัด']};
  ENDINGS.B={title:'Ending B — Income Booster',desc:'รายได้ไม่พอของจำเป็น เน้นเพิ่มรายได้ + สวัสดิการ/สหกรณ์',plan30:['หาอาชีพเสริม','ขอ OT/คอมมิชชั่น','ใช้สิทธิช่วยลดรายจ่าย','ประเมินสุขภาพ/เวลา'],roadmap12:['1–3: รายได้สุทธิ > 150% ของค่าใช้จ่ายจำเป็น','4–6: โปะดอกสูง','7–12: เงินฉุกเฉิน 1–3 เดือน'],checklist:['รายได้เสริม ≥ 20% ของค่างวด','ปิดบัตรดอกสูงใบแรก','เพิ่มทักษะระยะยาว']};
  ENDINGS.C={title:'Ending C — Finance Strategy',desc:'ไม่ติดลบแต่จ่ายไม่ถูกจุด ใช้ Avalanche/รีไฟแนนซ์',plan30:['จ่ายมากกว่าขั้นต่ำ 2x','รวม/รีไฟแนนซ์ดอกต่ำ','เรียงโปะตามดอก','พักบัตรหมุนเวียน'],roadmap12:['1–4: บัตรเหลือ < 50% วงเงิน','5–9: โยกไปดอกต่ำ','10–12: ออม 2 เท่าค่างวด'],checklist:['ปิดดอกสูงใน 12 เดือน','ติดตามยอดคงเหลือ','ตั้งออมอัตโนมัติ ≥10%']};
  ENDINGS.D={title:'Ending D — Restructuring Rescue',desc:'ภาระหนัก/เครดิตเสีย เน้นปรับโครงสร้าง + หยุดดอกบาน',plan30:['ติดต่อปรับโครงสร้าง','พักเงินต้นบางส่วน','ลำดับจ่าย ในระบบ→นอกระบบ','งบเข้ม 60–70% จำเป็น'],roadmap12:['1–3: ดอกคงที่ <10%','4–8: วินัย+เพิ่มรายได้','9–12: โปะต่อเนื่อง'],checklist:['หยุดผิดนัด','ปิดนอกระบบก่อน','เงินฉุกเฉิน ≥ 1 เดือน']};

  // ===== Questions (ตามเวอร์ชันก่อน) =====
  const Q = {
    q1:{title:'ปัจจุบันเงินเดือนติดลบหรือไม่?',hint:'ถ้ารายจ่ายต่อเดือนมากกว่ารายรับ ถือว่า "ติดลบ"',choices:[
      {key:'yes',label:'ติดลบ',onSelect:()=>{state.tags.cashflowNegative=true;return 'q2A';}},
      {key:'no',label:'ไม่ติดลบ',onSelect:()=>{state.tags.cashflowNegative=false;return 'q2B';}}
    ]},
    q2A:{title:'สาเหตุหลักของการติดลบคืออะไร?',choices:[
      {key:'lux',label:'ใช้ฟุ่มเฟือยเกินความจำเป็น',onSelect:()=>{state.tags.cause='lux';return 'q3A1';}},
      {key:'need',label:'ของจำเป็นเยอะ รายได้ยังไม่พอ',onSelect:()=>{state.tags.cause='need';return 'q3A2';}}
    ]},
    q3A1:{title:'พร้อมลดค่าใช้จ่ายฟุ่มเฟือยทันทีไหม?',choices:[
      {key:'yes',label:'พร้อมลด',onSelect:()=>{state.tags.canReduce=true;return 'q4A1';}},
      {key:'no',label:'ยังลดไม่ได้',onSelect:()=>{state.tags.canReduce=false;return 'q4A1';}}
    ]},
    q3A2:{title:'มีโอกาสหารายได้เสริมได้ไหม?',choices:[
      {key:'yes',label:'พอหาได้',onSelect:()=>{state.tags.canIncome=true;return 'q4A2';}},
      {key:'no',label:'ไม่มีเวลา/สุขภาพไม่เอื้อ',onSelect:()=>{state.tags.canIncome=false;return 'q4A2';}}
    ]},
    q4A1:{title:'มีค่าใช้จ่ายผูกมัดที่ปรับลดได้ไหม?',choices:[{key:'y',label:'มี',onSelect:()=> 'q5C'},{key:'n',label:'ไม่มี',onSelect:()=> 'q5C'}]},
    q4A2:{title:'เพิ่มรายได้ในงานปัจจุบันได้ไหม?',choices:[{key:'y',label:'พอเพิ่มได้',onSelect:()=> 'q5C'},{key:'n',label:'เพิ่มไม่ได้',onSelect:()=> 'q5C'}]},
    q2B:{title:'หนี้ของคุณกำลังโตขึ้นหรือไม่?',choices:[
      {key:'up',label:'โตขึ้น',onSelect:()=>{state.tags.debtTrend='up';return 'q3B1';}},
      {key:'flat',label:'คงที่/เริ่มลดแล้ว',onSelect:()=>{state.tags.debtTrend='flat';return 'q3B2';}}
    ]},
    q3B1:{title:'หนี้แบบไหนเป็นหลัก?',choices:[
      {key:'hi',label:'ดอกสูง (บัตร/บุคคล)',onSelect:()=>{state.tags.debtType='hi';return 'q4Common';}},
      {key:'long',label:'ระยะยาว (บ้าน/รถ)',onSelect:()=>{state.tags.debtType='long';return 'q4Common';}}
    ]},
    q3B2:{title:'มีเป้าหมายปลดหนี้ชัดเจนไหม?',choices:[{key:'y',label:'ชัดเจน',onSelect:()=> 'q4Common'},{key:'n',label:'ยังไม่มี',onSelect:()=> 'q4Common'}]},
    q4Common:{title:'เคยชำระล่าช้าหรือเครดิตเสียหรือไม่?',choices:[
      {key:'no',label:'ไม่เคย',onSelect:()=>{state.tags.creditBad=false;return 'q5Common';}},
      {key:'yes',label:'เคย/อยู่ระหว่าง',onSelect:()=>{state.tags.creditBad=true;return 'q5Common';}}
    ]},
    q5C:{title:'เคยชำระล่าช้าหรือเครดิตเสียหรือไม่?',choices:[
      {key:'no',label:'ไม่เคย',onSelect:()=>{state.tags.creditBad=false;return 'q6Common';}},
      {key:'yes',label:'เคย/อยู่ระหว่าง',onSelect:()=>{state.tags.creditBad=true;return 'q6Common';}}
    ]},
    q5Common:{title:'ยอดหนี้รวมมากกว่า 6 เท่าของรายได้ต่อปีหรือไม่?',choices:[
      {key:'no',label:'ไม่เกิน 6 เท่า',onSelect:()=>{state.tags.dtiHigh=false;return 'q6Common';}},
      {key:'yes',label:'เกิน 6 เท่า',onSelect:()=>{state.tags.dtiHigh=true;return 'q6Common';}}
    ]},
    q6Common:{title:'ตอนนี้จ่ายมากกว่าขั้นต่ำได้หรือไม่?',choices:[
      {key:'y',label:'พอจ่ายได้',onSelect:()=> 'q7Final'},
      {key:'n',label:'ยังทำไม่ได้',onSelect:()=> 'q7Final'}
    ]},
    q7Final:{title:'คุณพลาดจ่าย/ค้างจ่ายใน 3 เดือนล่าสุดไหม?',choices:[
      {key:'no',label:'ไม่พลาด',onSelect:()=>{state.tags.creditBad = state.tags.creditBad ?? false; return 'q8_income';}},
      {key:'yes',label:'มีพลาด/ค้าง',onSelect:()=>{state.tags.creditBad = true; return 'q8_income';}}
    ]},
    // Numeric
    q8_income:{title:'รายได้รวมต่อเดือน (บาท)',hint:'รวมเงินเดือนประจำ + รายได้เสริม (ถ้ามี)',input:{type:'number',id:'inp_income',placeholder:'เช่น 30000',min:0},onNext:(v)=>{state.numeric.inc=v;return 'q9_living';}},
    q9_living:{title:'ค่าใช้จ่ายในชีวิตประจำวัน/เดือน (บาท)',hint:'ที่อยู่อาศัย/อาหาร/เดินทาง/สาธารณูปโภค ฯลฯ',input:{type:'number',id:'inp_living',placeholder:'เช่น 18000',min:0},onNext:(v)=>{state.numeric.living=v;return 'q10_debtpay';}},
    q10_debtpay:{title:'จ่ายหนี้ต่อเดือน (บาท)',hint:'รวมค่างวดทุกเจ้าหนี้',input:{type:'number',id:'inp_debtpay',placeholder:'เช่น 6000',min:0},onNext:(v)=>{state.numeric.debtpay=v;return 'q10_5_saving';}},
    q10_5_saving:{title:'ออมต่อเดือน (บาท)',hint:'ยอดที่ออมจริงทุกเดือน (ถ้ายังไม่ออม ให้ใส่ 0)',input:{type:'number',id:'inp_saving',placeholder:'เช่น 3000',min:0},onNext:(v)=>{state.numeric.savingMonthly=v;return 'q11_eme';}},
    q11_eme:{title:'ปัจจุบันมีเงินออมสะสมทั้งหมด (บาท)',hint:'ใช้ประเมินเงินฉุกเฉิน (เดือน)',input:{type:'number',id:'inp_eme',placeholder:'เช่น 10000',min:0},onNext:(v)=>{state.numeric.eme=v;finishWithNumbers();}}
  };

  const el=(s)=>document.querySelector(s);

  // ===== RENDER =====
  function renderQuestion(qid){
    const q=Q[qid]; if(!q) return;
    state.isTransitioning=false;

    el('#qTitle').textContent=q.title;
    el('#qHint').textContent=q.hint||'';

    const wrap=el('#choices'); wrap.innerHTML='';
    el('#navRow').classList.add('hidden');
    el('#backOnlyRow').classList.remove('hidden');

    if(q.input && q.input.type==='number'){
      const box=document.createElement('div');
      box.className='col-span-2';
      box.innerHTML=`<label class='block'><input id='${q.input.id}' type='number' inputmode='decimal' min='${q.input.min??0}' class='input' placeholder='${q.input.placeholder||''}' /></label>`;
      wrap.appendChild(box);

      el('#navRow').classList.remove('hidden');
      el('#backOnlyRow').classList.add('hidden');

      el('#btnBackInline').onclick=goBack;
      const nextBtn=el('#btnNextInline');
      const inputEl=document.getElementById(q.input.id);
      const prev=state.answers[qid]; if(prev!=null) inputEl.value=prev;

      function submitNumber(){
        if(state.isTransitioning) return;
        const raw=inputEl.value.trim(); const val=parseFloat(raw);
        if(raw===''||isNaN(val)||val<(q.input.min??0)){ alert('กรุณากรอกตัวเลขให้ถูกต้อง'); return; }
        state.isTransitioning=true; nextBtn.disabled=true;
        const safe=Math.max(q.input.min??0,val);
        state.path.push(qid); state.answers[qid]=safe;
        const next=q.onNext? q.onNext(safe):null;
        if(next){ goNext(next); } else { state.isTransitioning=false; nextBtn.disabled=false; }
      }

      inputEl.addEventListener('keydown',e=>{ if(e.key==='Enter'){ e.preventDefault(); submitNumber(); }});
      nextBtn.onclick=submitNumber;

    }else{
      q.choices.forEach((c,idx)=>{
        const btn=document.createElement('button');
        btn.type='button'; btn.className='choice text-left';
        btn.innerHTML=`<div class="flex items-center justify-between">
          <div class="flex items-center gap-3">
            <span class="w-9 h-9 rounded-xl bg-slate-50 flex items-center justify-center font-semibold border border-slate-200">${idx+1}</span>
            <span class="font-semibold">${c.label}</span>
          </div>
          <svg xmlns='http://www.w3.org/2000/svg' class='w-5 h-5 text-slate-400' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'><path d='M9 18l6-6-6-6'/></svg>
        </div>`;
        btn.addEventListener('click',()=>{
          if(state.isTransitioning) return;
          state.isTransitioning=true;
          const next=c.onSelect();
          state.path.push(qid); state.answers[qid]=c.key;
          goNext(next);
        });
        wrap.appendChild(btn);
      });
    }

    el('#stepLabel').textContent=`คำถามที่ ${state.step}`;
    const pct=Math.max(1,Math.min(TOTAL_STEPS,state.step))/TOTAL_STEPS*100;
    el('#progressBar').style.width=pct+'%';
    el('#btnBack').disabled=state.step<=1;

    const b=[];
    if(state.tags.cashflowNegative===true) b.push('ติดลบ');
    if(state.tags.cashflowNegative===false) b.push('ไม่ติดลบ');
    if(state.tags.cause==='lux') b.push('ฟุ่มเฟือย');
    if(state.tags.cause==='need') b.push('จำเป็นเยอะ');
    if(state.tags.debtTrend==='up') b.push('หนี้โต');
    if(state.tags.debtTrend==='flat') b.push('หนี้คงที่/ลด');
    el('#pathBadge').textContent=b.length? b.join(' • '):'เริ่มต้น';
  }

  function goNext(nextId){
    if(typeof nextId==='function') nextId=nextId();
    if(nextId && Q[nextId]){
      state.step=Math.min(TOTAL_STEPS,state.step+1);
      renderQuestion(nextId);
      state.currentQ=nextId;
      window.scrollTo({top:0,behavior:'smooth'});
    }else{
      state.isTransitioning=false;
    }
  }
  function goBack(){
    if(state.step<=1) return;
    const lastQ=state.path.pop(); if(!lastQ) return;
    state.step-=1; state.currentQ=lastQ;
    renderQuestion(lastQ); window.scrollTo({top:0,behavior:'smooth'});
  }

  function deriveTagsFromMetrics(m){
    state.tags.cashflowNegative=(m.cashflow<0);
    state.tags.dtiHigh=(m.dti>=0.45);
    state.tags.creditRisk=(m.dti>=0.6);
  }

  function finishWithNumbers(){
    const n=state.numeric||{inc:0,living:0,debtpay:0,savingMonthly:0,eme:0};
    const inc=+n.inc||0, living=+n.living||0, debtPay=+n.debtpay||0, save=+n.savingMonthly||0, eme=+n.eme||0;
    const cashflow = inc - living - debtPay - save;        // ✅ หัก “ออมต่อเดือน”
    const dti = inc>0 ? (debtPay/inc) : NaN;
    const savingRate = inc>0 ? (save/inc) : NaN;
    const emeMonths = living>0 ? (eme/living) : NaN;
    state.metrics={inc,living,debtPay,save,cashflow,dti,savingRate,emeMonths};
    deriveTagsFromMetrics(state.metrics);

    let ending='D';
    const t=state.tags;
    if(t.creditBad===true || t.dtiHigh===true) ending='D';
    else if(t.cashflowNegative) ending=(t.cause==='lux')?'A':'B';
    else ending='C';

    state.step=TOTAL_STEPS;
    el('#stepLabel').textContent='เสร็จสิ้น';
    el('#progressBar').style.width='100%';
    showResult(ending);
  }

  // ===== Metrics + advice (พื้นฐาน) =====
  function attachResultMetrics(m){
    const box=el('#metricsAttach'); box.classList.remove('hidden');
    el('#r_cashflow').textContent=fmtBaht(m.cashflow);
    el('#r_dti').textContent=fmtPct(m.dti);
    el('#r_saving').textContent=fmtPct(m.savingRate);
    el('#r_eme').textContent=isFinite(m.emeMonths)? m.emeMonths.toFixed(1)+' เดือน':'-';

    const adv_cf=[];
    if(isFinite(m.cashflow) && m.cashflow<0){ adv_cf.push(`ควรเพิ่มสภาพคล่องอย่างน้อย ${fmtBaht(Math.abs(m.cashflow))}/เดือน (ลดรายจ่าย/เพิ่มรายได้/ชะลอการออมชั่วคราว)`); }
    else adv_cf.push('ดีมาก! สภาพคล่องเป็นบวก — กระจายไปออม/โปะหนี้ดอกสูง');

    const adv_dti=[];
    if(isFinite(m.dti)){
      const maxDebtPay=0.45*(m.inc||0);
      if(m.dti>0.45){
        const gap=Math.max(0,m.debtPay-maxDebtPay);
        adv_dti.push(`DTI เกินเกณฑ์ — ลดค่างวดอย่างน้อย ${fmtBaht(gap)}/เดือน หรือเพิ่มรายได้ให้ค่างวดรวม ≤ ${fmtBaht(maxDebtPay)} (45% ของรายได้)`);
      }else{
        adv_dti.push('DTI อยู่ในเกณฑ์ดี (≤ 45%) — รักษาวินัยชำระตรงเวลา');
      }
    }

    const adv_sv=[];
    if(isFinite(m.savingRate)){
      const targetSave=0.10*(m.inc||0);
      if(m.savingRate<0.10){
        const more=Math.max(0,targetSave-(m.save||0));
        adv_sv.push(`ออมต่ำกว่า 10% — เพิ่มออมอีกประมาณ ${fmtBaht(more)}/เดือน เพื่อถึงขั้นต่ำ 10%`);
      }else{
        adv_sv.push(`ออมถึงเกณฑ์แล้ว — ลองตั้งเป้า 15% ≈ ${fmtBaht(0.15*(m.inc||0))}/เดือน`);
      }
    }

    const adv_em=[];
    if(isFinite(m.emeMonths)){
      const targetAmt=3*(m.living||0);
      if(m.emeMonths<3){
        const shortfall=Math.max(0,targetAmt-(state.numeric.eme||0));
        if((m.save||0)>0){
          const months=ceil(shortfall/Math.max(1,m.save));
          adv_em.push(`เงินฉุกเฉินยังไม่ครบ 3 เดือน — ขาดประมาณ ${fmtBaht(shortfall)} (ออมเท่าเดิมจะใช้เวลาราว ${months} เดือน)`);
        }else{
          adv_em.push(`เริ่มสะสมเงินฉุกเฉินอย่างน้อย 3 เดือน ≈ ${fmtBaht(targetAmt)}`);
        }
      }else{
        adv_em.push('ถึงเกณฑ์ ≥ 3 เดือนแล้ว — แยกบัญชีฉุกเฉินต่างหากและอย่าหยิบใช้');
      }
    }

    el('#a_cashflow').textContent=adv_cf.join(' ');
    el('#a_dti').textContent=adv_dti.join(' ');
    el('#a_saving').textContent=adv_sv.join(' ');
    el('#a_eme').textContent=adv_em.join(' ');
  }

  function showResult(code){
    const data=ENDINGS[code];
    el('#qaCard').classList.add('hidden');
    el('#resultCard').classList.remove('hidden');

    const endingWrap=el('#endingBadge');
    endingWrap.innerHTML=`
      <div class="p-4 rounded-2xl border border-slate-200 bg-slate-50">
        <div class="font-semibold">${data.title}</div>
        <div class="text-sm text-slate-600 mt-1">${data.desc}</div>
      </div>`;

    if(state.metrics) attachResultMetrics(state.metrics);

    function fillList(id,items){ const ul=el(id); ul.innerHTML=''; items.forEach(t=>{const li=document.createElement('li'); li.textContent=t; ul.appendChild(li);}); }
    const m=state.metrics||{}, extra=[];
    if(isFinite(m.cashflow)&&m.cashflow<0) extra.push('สภาพคล่องติดลบ: ลดรายจ่ายผูกมัด/เพิ่มรายได้');
    if(isFinite(m.dti)&&m.dti>0.45) extra.push('DTI > 45%: เจรจาปรับโครงสร้าง/รวมหนี้ดอกต่ำ');
    if(isFinite(m.savingRate)&&m.savingRate<0.10) extra.push('ออม < 10%: ตั้งตัดออมอัตโนมัติ ≥ 10%');
    if(isFinite(m.emeMonths)&&m.emeMonths<3) extra.push('เงินฉุกเฉิน < 3 เดือน: เร่งสะสมก่อนลงทุนเสี่ยง');

    const e=ENDINGS[code];
    fillList('#plan30',[...e.plan30,...extra]);
    fillList('#roadmap12',e.roadmap12);
    fillList('#checklist',e.checklist);

    window.scrollTo({top:0,behavior:'smooth'});
  }

  // ===== AI Advisor (ออฟไลน์ + ออนไลน์) =====
  function buildCaseSummary(){
    const m=state.metrics||{};
    const t=state.tags||{};
    return {
      numbers:{
        income:m.inc, living:m.living, debtPay:m.debtPay, savingMonthly:m.save, emergencyFund:state.numeric.eme,
        cashflow:m.cashflow, dti:m.dti, savingRate:m.savingRate, emeMonths:m.emeMonths
      },
      flags:{
        cashflowNegative:t.cashflowNegative, dtiHigh:t.dtiHigh, creditRisk:t.creditRisk,
        cause:t.cause, debtTrend:t.debtTrend, debtType:t.debtType, creditBad:t.creditBad
      }
    };
  }

  function offlineAdvice(){
    const c=buildCaseSummary();
    const n=c.numbers;
    const lines=[];
    lines.push(`ภาพรวม: รายได้ ${fmtBaht(n.income)}, ค่าใช้จ่าย ${fmtBaht(n.living)}, จ่ายหนี้ ${fmtBaht(n.debtPay)}, ออม/เดือน ${fmtBaht(n.savingMonthly)} → สภาพคล่อง ${fmtBaht(n.cashflow)}, DTI ${fmtPct(n.dti)}, ออม ${fmtPct(n.savingRate)}, เงินฉุกเฉิน ${isFinite(n.emeMonths)?n.emeMonths.toFixed(1)+' เดือน':'-'} `);

    const steps=[];
    if(isFinite(n.cashflow) && n.cashflow<0){
      steps.push(`พลิกสภาพคล่องอย่างน้อย ${fmtBaht(Math.abs(n.cashflow))}/เดือน (ลดรายจ่ายผูกมัด/เพิ่มรายได้/ชะลอการออมชั่วคราว)`);
    }
    if(isFinite(n.dti) && n.dti>0.45){
      const maxDebtPay=0.45*(n.income||0);
      const gap=Math.max(0,(n.debtPay||0)-maxDebtPay);
      steps.push(`ลดค่างวดรวมอย่างน้อย ${fmtBaht(gap)} ให้ DTI ≤ 45% (เป้าหมายค่างวดรวม ≤ ${fmtBaht(maxDebtPay)})`);
    }
    if(isFinite(n.savingRate) && n.savingRate<0.10){
      const need=Math.max(0,0.10*(n.income||0)-(n.savingMonthly||0));
      steps.push(`เพิ่มออมอีก ${fmtBaht(need)}/เดือน เพื่อแตะ 10% ของรายได้`);
    }
    if(isFinite(n.emeMonths) && n.emeMonths<3){
      const target=3*(n.living||0);
      const shortfall=Math.max(0,target-(state.numeric.eme||0));
      if((n.savingMonthly||0)>0){
        const months=ceil(shortfall/Math.max(1,n.savingMonthly));
        steps.push(`สะสมเงินฉุกเฉินให้ครบอย่างน้อย 3 เดือน (ขาด ${fmtBaht(shortfall)} ~ ใช้เวลาประมาณ ${months} เดือนที่ระดับออมปัจจุบัน)`);
      } else {
        steps.push(`เริ่มออมทันทีอย่างน้อย 10% จนเงินฉุกเฉินครบ ~ ${fmtBaht(target)}`);
      }
    }

    // แนวทางเฉพาะตามสาเหตุ
    if(c.flags.cause==='lux'){ steps.push('ตัดค่าใช้จ่ายฟุ่มเฟือย 2–3 รายการใหญ่ทันที และแช่แข็งบัตรที่ใช้หนัก 1 ใบ'); }
    if(c.flags.cause==='need'){ steps.push('คงรายจ่ายจำเป็น เน้นเพิ่มรายได้ (โอที/งานเสริม) และใช้สิทธิ/สวัสดิการลดคงที่'); }
    if(c.flags.debtType==='hi'){ steps.push('ใช้กลยุทธ์ Avalanche: โปะหนี้ดอกสูงที่สุดก่อน พร้อมพิจารณารีไฟแนนซ์/รวมหนี้ดอกต่ำ'); }
    if(c.flags.creditBad){ steps.push('ติดต่อเจ้าหนี้เพื่อปรับโครงสร้าง/ผ่อนปรน หากมีค้างชำระ/สถานะ NPL'); }

    const html = `
      <div class="p-4 border border-slate-200 rounded-2xl bg-slate-50">
        <div class="font-semibold mb-2">สรุปเชิงวิเคราะห์</div>
        <p class="text-sm text-slate-700">${lines.join(' ')}</p>
        <div class="font-semibold mt-3 mb-1">สิ่งที่ควรทำถัดไป (เรียงลำดับ)</div>
        <ol class="list-decimal pl-5 space-y-1 text-sm text-slate-700">
          ${steps.map(s=>`<li>${s}</li>`).join('')}
        </ol>
      </div>`;
    return html;
  }

  async function onlineAdvice(){
    const base = localStorage.getItem('ai_base') || '';
    const key  = localStorage.getItem('ai_key')  || '';
    const model= localStorage.getItem('ai_model')|| 'gpt-4o-mini';
    if(!base || !key){ throw new Error('ยังไม่ได้ตั้งค่า AI (Base URL / API Key)'); }

    const extra = el('#aiExtra').value?.trim() || '';
    const summary = buildCaseSummary();
    const prompt = `คุณเป็นที่ปรึกษาการเงินส่วนบุคคลระดับมืออาชีพ (สื่อสารไทย ชัดเจน กระชับ เป็นขั้นตอน)
ข้อมูลผู้ใช้ (JSON):
${JSON.stringify(summary, null, 2)}
บริบทเพิ่มเติม: ${extra || '-'}
กรุณาสรุป:
1) ภาพรวมสถานการณ์ (1 ย่อหน้า)
2) สิ่งที่ต้องทำ 3–7 ข้อ (เรียงลำดับ มีตัวเลขเป้าหมายชัดเจน เช่น DTI ≤45%, ออม ≥10%, เงินฉุกเฉิน ≥3 เดือน)
3) หมายเหตุความเสี่ยง/ข้อควรระวังสั้น ๆ`;

    // เรียก Chat Completions แบบทั่วไป (OpenAI-compatible)
    const res = await fetch(`${base.replace(/\/$/,'')}/chat/completions`,{
      method:'POST',
      headers:{ 'Content-Type':'application/json', 'Authorization':`Bearer ${key}` },
      body: JSON.stringify({
        model, temperature:0.3,
        messages:[
          {role:'system', content:'You are a Thai-speaking certified personal finance advisor (CFP-style), precise and actionable.'},
          {role:'user', content: prompt}
        ]
      })
    });
    if(!res.ok){ const t=await res.text(); throw new Error(`API error: ${res.status} ${t}`); }
    const data = await res.json();
    const text = data.choices?.[0]?.message?.content || '(ไม่มีข้อความตอบกลับ)';
    return `<div class="p-4 border border-slate-200 rounded-2xl bg-white whitespace-pre-wrap text-sm text-slate-800">${text}</div>`;
  }

  function renderAi(html){
    const out=el('#aiOutput');
    out.innerHTML = html;
  }

  // ===== INIT & EVENTS =====
  function init(){
    state.step=1; state.path=[]; state.answers={}; state.isTransitioning=false;
    state.tags={ cashflowNegative:null, cause:null, canReduce:null, canIncome:null, debtTrend:null, debtType:null, creditBad:null, dtiHigh:null, creditRisk:null };
    state.numeric={ inc:0, living:0, debtpay:0, savingMonthly:0, eme:0 };
    state.metrics=null; state.currentQ='q1';

    el('#resultCard').classList.add('hidden');
    el('#qaCard').classList.remove('hidden');
    el('#pathBadge').textContent='เริ่มต้น';
    el('#progressBar').style.width=(100/TOTAL_STEPS)+'%';
    el('#totalSteps').textContent=TOTAL_STEPS;
    el('#totalStepsText').textContent=`${TOTAL_STEPS} ขั้น`;
    renderQuestion('q1');
    renderAi('<div class="text-sm text-slate-500">ผลลัพธ์ AI จะแสดงที่นี่</div>');
  }

  document.addEventListener('DOMContentLoaded',()=>{
    el('#btnBack').addEventListener('click',goBack);
    el('#btnReset').addEventListener('click',init);
    el('#btnStartOver')?.addEventListener('click',init);
    el('#btnCopy')?.addEventListener('click',()=>{ try{ navigator.clipboard.writeText(document.body.innerText||''); alert('คัดลอกสรุปเรียบร้อย'); }catch{} });
    el('#btnPrint').addEventListener('click',()=>window.print());

    // AI buttons
    el('#btnRunOffline').addEventListener('click',()=>{
      if(!state.metrics){ alert('กรุณาตอบคำถามจนจบเพื่อให้มีข้อมูลวิเคราะห์'); return; }
      renderAi('<div class="text-sm text-slate-500">กำลังวิเคราะห์แบบออฟไลน์…</div>');
      const html = offlineAdvice();
      renderAi(html);
    });
    el('#btnRunOnline').addEventListener('click', async ()=>{
      if(!state.metrics){ alert('กรุณาตอบคำถามจนจบเพื่อให้มีข้อมูลวิเคราะห์'); return; }
      renderAi('<div class="text-sm text-slate-500">กำลังเรียกใช้ AI ออนไลน์…</div>');
      try{
        const html = await onlineAdvice();
        renderAi(html);
      }catch(err){
        renderAi(`<div class="p-3 rounded-xl bg-rose-50 border border-rose-200 text-rose-800 text-sm">ไม่สามารถเรียกใช้งาน AI ออนไลน์ได้: ${err.message}</div>`);
      }
    });

    // AI settings modal
    el('#btnAiSettings').addEventListener('click',()=>{
      el('#aiBase').value  = localStorage.getItem('ai_base')  || 'https://api.openai.com/v1';
      el('#aiKey').value   = localStorage.getItem('ai_key')   || '';
      el('#aiModel').value = localStorage.getItem('ai_model') || 'gpt-4o-mini';
      el('#aiSettings').classList.remove('hidden');
    });
    el('#btnCloseSettings').addEventListener('click',()=> el('#aiSettings').classList.add('hidden'));
    el('#btnSaveSettings').addEventListener('click',()=>{
      localStorage.setItem('ai_base',  el('#aiBase').value.trim());
      localStorage.setItem('ai_key',   el('#aiKey').value.trim());
      localStorage.setItem('ai_model', el('#aiModel').value.trim() || 'gpt-4o-mini');
      el('#aiSettings').classList.add('hidden');
      alert('บันทึกการตั้งค่า AI แล้ว');
    });

    init();
  });
  </script>
</body>
</html>
